<html>
<head>
<link rel="stylesheet" type="text/css" href="/style.css">
<title>Underload</title>
<script type="text/javascript">
function U(I,O)
{
 q=d=0;
 function chomp()
 {
  q=i;
  d=0;
  do
  {
   if(I[i]==')')
    d++;
   if(I[i]=='(')
    d--;
   i--;
  }while(d);
  return I.slice(i+2,q)
 }
 O(I+' ');
 for(i=I.length-1;i>=0;i--)
  if(I.charAt(i).match("[~:!*a^S]")&&!I.charAt(i-1).match("[~:!*a^S]"))
   switch(I[i])
   {
    case '~':
     i--;
     O("SWAP<br/>");
     t=i;
     after=I.slice(i+2);
     B=chomp();
     A=chomp();
     before=I.slice(0,i+1);
     U(before+'('+B+")("+A+')'+after,O);
     break;
    case ':':
     i--;
     O("DUP<br/>");
     t=i;
     after=I.slice(i+2);
     A=chomp();
     before=I.slice(0,i+1);
     U(before+'('+A+")("+A+')'+after,O);
     break;
    case '!':
     i--;
     O("DROP<br/>");
     t=i;
     after=I.slice(i+2);
     A=chomp();
     before=I.slice(0,i+1);
     U(before+after,O);
     break;
    case '*':
     i--;
     O("CAT<br/>");
     t=i;
     after=I.slice(i+2);
     B=chomp();
     A=chomp();
     before=I.slice(0,i+1);
     U(before+'('+A+B+')'+after,O);
     break;
    case 'a':
     i--;
     O("QUOTE<br/>");
     t=i;
     after=I.slice(i+2);
     A=chomp();
     before=I.slice(0,i+1);
     U(before+"(("+A+"))"+after,O);
     break;
    case '^':
     i--;
     O("EXEC<br/>");
     t=i;
     after=I.slice(i+2);
     A=chomp();
     before=I.slice(0,i+1);
     U(before+A+after,O);
     break;
    case 'S':
     i--;
     O("OUT<br/>");
     t=i;
     after=I.slice(i+2);
     B=chomp();
     Q=I[i];
	 if(Q=='S')
		i--;
     A=chomp();
     before=I.slice(0,i+1);
	 if(cc==0||typeof Q === "undefined")
	 {
	  O(B);
	  return;
	 }
	 cc--;
	 /*alert(
	  "before="+before+'\n'+
	  "A="+A+'\n'+
	  "B="+B+'\n'+
	  "Q="+Q+'\n'+
	  "after="+after+'\n'
	 );*/
     if(Q=='S')
      U(before+'('+A+B+")S"+after,O);
     else
      U(before+'('+B+")S("+A+')'+after,O);
     break;
   }
}
function go()
{
	cc=10;
	document.getElementById("out").innerHTML="";
	U(document.getElementById("in").value,
	function(_)
	{
		document.getElementById("out").innerHTML+=_;
	});
}
</script>
</head>
<body>
<!--#include virtual="/menu.html" -->
<h1>Underload</h1>
<textarea id="in"></textarea><br/>
<button OnClick="go();">RUN</button><br/>
<div id="out"></div><br/>
</body>
</html>